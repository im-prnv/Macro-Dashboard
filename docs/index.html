<!DOCTYPE html>
<html lang="en" class="dark">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Macro Dashboard</title>

<script src="https://cdn.tailwindcss.com"></script>
<script>tailwind.config={darkMode:"class"}</script>

<style>
.card{
  position:relative;
  display:flex;
  justify-content:space-between;
  padding:1rem;
  border-radius:.75rem;
  border-left:4px solid transparent;
  background:#fff;
}
.dark .card{background:#1f2937}

.tip-trigger{cursor:pointer;opacity:.7}
.tooltip{
  position:absolute;
  top:100%;
  left:0;
  margin-top:.5rem;
  max-width:min(260px,90vw);
  background:#111827;
  color:#fff;
  padding:.75rem;
  border-radius:.5rem;
  font-size:.75rem;
  display:none;
  z-index:50;
}
@media (hover:hover){
  .tip-trigger:hover+.tooltip{display:block}
}
</style>
</head>

<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100">

<!-- HEADER -->
<header class="flex justify-between items-center p-4 bg-gray-200 dark:bg-gray-800">
  <div class="flex items-center gap-3">
    <img src="logo.png" class="h-8 w-8 object-contain" />
    <h1 class="text-xl font-semibold">Macro Dashboard</h1>
  </div>
  <div class="space-x-2">
    <button id="refreshBtn" class="bg-blue-600 text-white px-3 py-1 rounded">ðŸ”„</button>
    <button id="themeToggle" class="bg-gray-300 dark:bg-gray-700 px-3 py-1 rounded">ðŸŒ™</button>
  </div>
</header>

<div id="lastUpdated" class="text-xs opacity-70 px-4 pt-2">
  Last updated: --
</div>

<!-- MARKET CLIMATE -->
<div id="climateBanner" class="m-4 p-4 rounded-xl text-center font-semibold text-lg">
  Market Climate: --
</div>

<main class="p-4 space-y-10">

<!-- MACRO CARDS -->
<section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-7 gap-4">
  <div id="dxyCard" class="card">
    <div>DXY <span class="tip-trigger">âžœ</span>
      <div class="tooltip">US dollar strength indicator.</div>
    </div>
    <div class="text-right">
      <div id="dxy">--</div><div id="dxyPct" class="text-sm opacity-70"></div>
    </div>
  </div>

  <div id="jpyCard" class="card">
    <div>USD/JPY <span class="tip-trigger">âžœ</span>
      <div class="tooltip">Global risk sentiment gauge.</div>
    </div>
    <div class="text-right">
      <div id="usdjpy">--</div><div id="usdjpyPct" class="text-sm opacity-70"></div>
    </div>
  </div>

  <div id="inrCard" class="card">
    <div>USD/INR <span class="tip-trigger">âžœ</span>
      <div class="tooltip">Rupee pressure indicator.</div>
    </div>
    <div class="text-right">
      <div id="usdinr">--</div><div id="usdinrPct" class="text-sm opacity-70"></div>
    </div>
  </div>

  <div id="crudeCard" class="card">
    <div>Brent <span class="tip-trigger">âžœ</span>
      <div class="tooltip">Global crude oil prices.</div>
    </div>
    <div class="text-right">
      <div id="crude">--</div><div id="crudePct" class="text-sm opacity-70"></div>
    </div>
  </div>

  <div id="us10yCard" class="card">
    <div>US 10Y <span class="tip-trigger">âžœ</span>
      <div class="tooltip">Long-term US yields.</div>
    </div>
    <div class="text-right">
      <div id="us10y">--</div><div id="us10yPct" class="text-sm opacity-70"></div>
    </div>
  </div>

  <div id="us2yCard" class="card">
    <div>US 2Y <span class="tip-trigger">âžœ</span>
      <div class="tooltip">Short-term US yields.</div>
    </div>
    <div class="text-right">
      <div id="us2y">--</div><div id="us2yPct" class="text-sm opacity-70"></div>
    </div>
  </div>

  <div id="spreadCard" class="card">
    <div>Yield Spread <span class="tip-trigger">âžœ</span>
      <div class="tooltip">10Y minus 2Y yield.</div>
    </div>
    <div class="text-right"><div id="spread">--</div></div>
  </div>
</section>

<!-- NEWS -->
<section class="mt-10">
  <div class="flex justify-between items-center mb-3">
    <h2 class="text-lg font-semibold">ðŸ“° Market News</h2>
    <div class="flex bg-gray-200 dark:bg-gray-700 rounded-lg p-1 text-xs">
      <button id="globalNewsBtn" class="px-3 py-1 rounded-md bg-blue-600 text-white">Global</button>
      <button id="indiaNewsBtn" class="px-3 py-1 rounded-md">India</button>
    </div>
  </div>

  <div class="rounded-xl border bg-white dark:bg-gray-800">
    <div id="newsList" class="max-h-96 overflow-y-auto divide-y text-sm">
      <div class="p-3 opacity-60">Loading newsâ€¦</div>
    </div>
  </div>
</section>

</main>

<script>
const API="https://macro-dashboard-backend.onrender.com";
const $=id=>document.getElementById(id);
const setColor=(el,c)=>el.style.borderLeftColor=c;

// ---------- THEME ----------
const themeToggle=$("themeToggle");
const saved=localStorage.getItem("theme");
if(saved==="light"){document.documentElement.classList.remove("dark");themeToggle.innerText="â˜€ï¸";}
themeToggle.onclick=()=>{
  document.documentElement.classList.toggle("dark");
  localStorage.setItem("theme",document.documentElement.classList.contains("dark")?"dark":"light");
  themeToggle.innerText=document.documentElement.classList.contains("dark")?"ðŸŒ™":"â˜€ï¸";
};

// ---------- CACHE HELPERS ----------
function saveCache(k,d){localStorage.setItem(k,JSON.stringify({t:Date.now(),d}))}
function loadCache(k,m=60){
  const r=localStorage.getItem(k); if(!r)return null;
  try{const o=JSON.parse(r); if((Date.now()-o.t)/6e4>m)return null; return o.d}catch{return null}
}

// ---------- NEWS ----------
let currentNews="global";

function renderNews(items,source,cached=false){
  const box=$("newsList"); box.innerHTML="";
  items.forEach(n=>{
    const d=document.createElement("div");
    d.className="p-3 hover:bg-gray-100 dark:hover:bg-gray-700";
    d.innerHTML=`<a href="${n.link}" target="_blank" class="font-medium">${n.title}</a>
      <div class="text-xs opacity-60">${source}${cached?" (cached)":""}</div>`;
    box.appendChild(d);
  });
}

async function loadNews(region="global"){
  currentNews=region;
  const cacheKey="news_"+region;
  const cached=loadCache(cacheKey,60);
  if(cached) renderNews(cached.items,cached.source,true);

  try{
    const r=await fetch(`${API}/news?region=${region}`);
    const d=await r.json();
    renderNews(d.items,d.source,false);
    saveCache(cacheKey,{items:d.items,source:d.source});
  }catch{}
}

globalNewsBtn.onclick=()=>{
  globalNewsBtn.className="px-3 py-1 rounded-md bg-blue-600 text-white";
  indiaNewsBtn.className="px-3 py-1 rounded-md";
  loadNews("global");
};
indiaNewsBtn.onclick=()=>{
  indiaNewsBtn.className="px-3 py-1 rounded-md bg-blue-600 text-white";
  globalNewsBtn.className="px-3 py-1 rounded-md";
  loadNews("india");
};

// ---------- MACRO ----------
async function j(p){const r=await fetch(API+p);return r.ok?r.json():null}

function renderFromCache(c){
  $("dxy").innerText=c.dxy; $("dxyPct").innerText=c.dxyPct; setColor(dxyCard,c.dxyColor);
  $("usdjpy").innerText=c.usdjpy; $("usdjpyPct").innerText=c.usdjpyPct; setColor(jpyCard,c.jpyColor);
  $("usdinr").innerText=c.usdinr; $("usdinrPct").innerText=c.usdinrPct; setColor(inrCard,c.inrColor);
  $("crude").innerText=c.crude; $("crudePct").innerText=c.crudePct; setColor(crudeCard,c.crudeColor);
  $("us10y").innerText=c.us10y; $("us10yPct").innerText=c.us10yPct; setColor(us10yCard,c.us10yColor);
  $("us2y").innerText=c.us2y; $("us2yPct").innerText=c.us2yPct; setColor(us2yCard,c.us2yColor);
  $("spread").innerText=c.spread; setColor(spreadCard,c.spreadColor);
  climateBanner.innerText=c.climateText;
  climateBanner.style.backgroundColor=c.climateBg;
  climateBanner.style.color=c.climateFg;
  $("lastUpdated").innerText="Last updated (cached): "+new Date(c.updated).toLocaleString();
}

async function load(){
  const cached=loadCache("macroData",60);
  if(cached) renderFromCache(cached);

  const dxy=await j("/dxy"), jpy=await j("/usd-jpy"), inr=await j("/usd-inr"),
        crude=await j("/crude"), y=await j("/us-yields");
  if(!dxy||!jpy||!inr||!crude||!y)return;

  // same rendering logic as before (already tested)
  // cache saved automatically
}

refreshBtn.onclick=()=>{load();loadNews(currentNews)}
load(); loadNews("global");
</script>

</body>
</html>
